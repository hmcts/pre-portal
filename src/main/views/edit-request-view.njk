{% extends "template.njk" %}

{% block pageTitle %}Edit Request - PRE Portal{% endblock %}

{% block head %}
  {% include "webpack/css.njk" %}
  <script type="text/javascript" src="/assets/js/mkplayer.js"></script>
  <link rel="stylesheet" href="/assets/css/mkplayer-ui.css">
{% endblock %}

{% block beforeContent %}
  {{
  govukBackLink({
    "href": "javascript:history.back()"
  })
  }}
{% endblock %}

{% block content %}
  {% if editRequest.status == "SUBMITTED" %}
    <h1 class="govuk-heading-xl">Submitted edits for case reference {{ recording.case_reference }}</h1>
  {% else %}
    <h1 class="govuk-heading-xl">Submit edits for case reference {{ recording.case_reference }}</h1>
  {% endif %}
  <table class="govuk-table">
    <thead class="govuk-table__head">
      <tr class="govuk-table__row">
        <th scope="col" class="govuk-table__header">Start Time</th>
        <th scope="col" class="govuk-table__header">End Time</th>
        <th scope="col" class="govuk-table__header">Time Removed</th>
        <th scope="col" class="govuk-table__header">Reason</th>
      </tr>
    </thead>
    <tbody class="govuk-table__body">
    {% for instruction in editRequest.edit_instructions %}
      <tr id="instruction-{{ loop.index0 }}" class="govuk-table__row">
        <td class="govuk-table__cell">{{ instruction.start_of_cut }}</td>
        <td class="govuk-table__cell">{{ instruction.end_of_cut }}</td>
        <td class="govuk-table__cell">{{ instruction.difference }}</td>
        <td class="govuk-table__cell">{{ instruction.reason }}</td>
      </tr>
    {% endfor %}
    </tbody>
  </table>

  {% if editRequest.status != 'DRAFT' %}
    <div style="margin-top: 45px;">
      <p class="govuk-body">Submission date: {{ editRequest.modified_at }}</p>
      <p class="govuk-body">Submitted by: {{ editRequest.created_by }}</p>
      <p class="govuk-body">
        I confirm that all of the above edits have been jointly agreed by defence and prosecution advocates:
        {% if editRequest.jointly_agreed %}
          Yes
        {% else %}
          No
        {% endif %}
      </p>
    </div>
  {% else %}
  <form onsubmit="onSubmit(event)">
    <div id="form-group" class="govuk-form-group" style="margin-top: 45px;">
      <fieldset class="govuk-fieldset">
        <legend class="govuk-fieldset__legend">
          I confirm that all of the above edits have been jointly agreed by defence and prosecution advocates.
        </legend>
        <p id="error-message" class="govuk-error-message"></p>
        <div class="govuk-radios" data-module="govuk-radios">
          <div class="govuk-radios__item">
            <input class="govuk-radios__input" id="jointlyAgreed-yes" name="jointlyAgreed" type="radio" value="yes">
            <label class="govuk-label govuk-radios__label" for="jointlyAgreed-yes">
              Yes
            </label>
          </div>
          <div class="govuk-radios__item">
            <input class="govuk-radios__input" id="jointlyAgreed-no" name="jointlyAgreed" type="radio" value="no">
            <label class="govuk-label govuk-radios__label" for="jointlyAgreed-no">
              No
            </label>
          </div>
        </div>
      </fieldset>
    </div>

    <div class="actions-bar govuk-body">
      <a class="govuk-link cancel-link" href="/edit-request/{{ recording.id }}"><span style="vertical-align: center">Cancel</span><span class="govuk-visually-hidden"> submission</span></a>
      <button class="govuk-button" type="submit">Confirm Submission</button>
    </div>
  </form>

  <style>
    div.actions-bar {
      display: inline-flex;
      justify-content: flex-end;
      vertical-align: bottom;
      width: 100%;
    }
    a.cancel-link {
      display: flex;
      align-items: center;
      height: 40px;

      margin-right: 0.5rem;
    }
  </style>
  <script type="text/javascript" crossorigin="anonymous" data-testid="edit-request-submissions">
    let editRequest = JSON.parse("{{ editRequest | dump  }}".replace(/&quot;/g, '"'));

    const onError = () => {
      const errorMessage = document.getElementById('error-message');
      errorMessage.innerHTML = '<span class="govuk-visually-hidden">Error:</span> Select an option'

      const formGroup = document.getElementById('form-group');
      formGroup.classList.add('govuk-form-group--error');
    };

    const onSubmit = (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const jointlyAgreed = formData.get('jointlyAgreed');

      if (!jointlyAgreed) {
        onError();
        return;
      }

      fetch("{{ postUrl }}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "accept": "application/json",
        },
        body: JSON.stringify({
          ...editRequest,
          jointly_agreed: jointlyAgreed === 'yes',
          status: 'SUBMITTED',
        }),
      }).then(async (response) => {
        if(!response.ok) {
          throw new Error(response);
        }
        window.location.href = '/browse';
      }).catch((error) => {
        console.error(error);
      });
    };
  </script>
  {% endif %}
{% endblock %}
